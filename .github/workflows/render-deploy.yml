name: Deploy to Render

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to Render
      uses: johnbeynon/render-deploy@v1.0.1
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
    
    - name: Wait for deployment
      run: |
        echo "Waiting for Render deployment to complete..."
        sleep 30
    
    - name: Health check
      run: |
        SERVICE_URL="${{ secrets.RENDER_SERVICE_URL }}"
        if [ -n "$SERVICE_URL" ]; then
          echo "Checking service health at $SERVICE_URL/docs"
          curl -f "$SERVICE_URL/docs" || exit 1
          echo "✅ Service is healthy"
        else
          echo "⚠️  RENDER_SERVICE_URL not set, skipping health check"
        fi
      continue-on-error: true

